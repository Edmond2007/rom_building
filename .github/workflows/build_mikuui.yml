name: Build Miku UI (Vampire_v3)

on:
  workflow_dispatch:
    branches: [ main ]

env:
  CCACHE_DIR: /tmp/ccache
  USE_CCACHE: 1
  SWAP_SIZE: 8G
  REPO_DEPTH: 1

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 380  # –ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π

    steps:
      # 1. –û—á–∏—Å—Ç–∫–∞ –¥–∏—Å–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      - name: Setup environment and clean disk
        run: |
          # –û—á–∏—Å—Ç–∫–∞ –¥–∏—Å–∫–∞
          sudo apt-get clean
          sudo rm -rf /usr/local/lib/android/
          sudo rm -rf /var/lib/apt/lists/*
          
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ swap
          sudo fallocate -l $SWAP_SIZE /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          sudo apt-get update -y
          sudo apt-get install -y \
            ccache git-core python3 python-is-python3 \
            libssl-dev libncurses5-dev curl openssh-client \
            bc bison flex zip unzip lzop pkg-config
          
          df -h

      # 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ repo
      - name: Install repo
        run: |
          sudo curl -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod a+rx /usr/local/bin/repo
          repo --version

      # 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ
      - name: Telegram notification (start)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üèóÔ∏è *–°–±–æ—Ä–∫–∞ –Ω–∞—á–∞—Ç–∞*
            ‚ñ´Ô∏è *–í–µ—Ä—Å–∏—è:* Vampire_v3
            ‚ñ´Ô∏è *–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:* blossom
            ‚ñ´Ô∏è *–í—Ä–µ–º—è:* $(date +'%Y-%m-%d %H:%M:%S')
            ‚ñ´Ô∏è *–°—Å—ã–ª–∫–∞:* [GitHub](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown

      # 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Initialize repo
        run: |
          git config --global user.name "Edmond2007"
          git config --global user.email "edmondseropyan6@gmail.com"
          
          repo init \
            -u https://github.com/Miku-UI/manifesto \
            -b Vampire_v3 \
            --depth=$REPO_DEPTH \
            --partial-clone \
            --clone-filter=blob:limit=5M || exit 1

      # 5. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞
      - name: Sync code
        run: |
          repo sync \
            -c \
            -j2 \
            --force-sync \
            --no-clone-bundle \
            --no-tags \
            --optimized-fetch \
            --current-branch || exit 1
          
          repo forall -c 'git gc --aggressive'
          df -h

      # 6. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ device tree
      - name: Apply device trees
        run: |
          git clone \
            --depth=1 \
            --filter=blob:limit=5M \
            https://github.com/Edmond2007/android_device_xiaomi_blossom_local_manifests.git \
            .repo/local_manifests || exit 1
          
          repo sync -c -j2 --fail-fast || exit 1

      # 7. –°–±–æ—Ä–∫–∞
      - name: Build ROM
        run: |
          export CCACHE_COMPRESS=1
          ccache -M 30G
          ccache -s
          
          source build/envsetup.sh || exit 1
          lunch miku_blossom-userdebug || exit 1
          mka bacon -j$(($(nproc --all) - 2)) || exit 1

      # 8. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      - name: Telegram notification (success)
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚úÖ *–°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞!*
            ‚ñ´Ô∏è *–í–µ—Ä—Å–∏—è:* Vampire_v3
            ‚ñ´Ô∏è *–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:* blossom
            ‚ñ´Ô∏è *–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:* [Download](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown

      # 9. –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Miku-UI-Vampire_v3-${{ github.run_number }}
          path: out/target/product/blossom/*.zip
          retention-days: 3

      # 10. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ—É–¥–∞—á–µ
      - name: Telegram notification (failure)
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚ùå *–°–±–æ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞!*
            ‚ñ´Ô∏è *–õ–æ–≥:* [View](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown

      # 11. –û—á–∏—Å—Ç–∫–∞
      - name: Cleanup
        if: always()
        run: |
          sudo swapoff /swapfile || true
          sudo rm -f /swapfile || true
          ccache -s
