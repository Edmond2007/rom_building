name: Build Miku UI (Vampire_v3)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  CCACHE_DIR: /tmp/ccache
  USE_CCACHE: 1
  SWAP_SIZE: 16G
  REPO_DEPTH: 1
  BUILD_TIMEOUT: 380  # –º–∏–Ω—É—Ç—ã

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ env.BUILD_TIMEOUT }}

    steps:
      # 1. –û—á–∏—Å—Ç–∫–∞ –¥–∏—Å–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      - name: Setup environment and clean disk
        run: |
          # –û—á–∏—Å—Ç–∫–∞ –¥–∏—Å–∫–∞
          sudo apt-get clean
          sudo rm -rf /usr/local/lib/android/
          sudo rm -rf /var/lib/apt/lists/*
          
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ swap
          sudo fallocate -l $SWAP_SIZE /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          sudo apt-get update -y
          sudo apt-get install -y \
            ccache git-core python3 python-is-python3 \
            libssl-dev libncurses5-dev curl openssh-client \
            bc bison flex zip unzip lzop pkg-config
          
          df -h

      # 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ repo
      - name: Install repo
        run: |
          sudo curl -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod a+rx /usr/local/bin/repo
          repo --version

      # 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ
      - name: Telegram notification (start)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üèóÔ∏è *–°–±–æ—Ä–∫–∞ –Ω–∞—á–∞—Ç–∞*
            ‚ñ´Ô∏è *–í–µ—Ä—Å–∏—è:* Vampire_v3
            ‚ñ´Ô∏è *–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:* blossom
            ‚ñ´Ô∏è *–í—Ä–µ–º—è:* $(date +'%Y-%m-%d %H:%M:%S')
            ‚ñ´Ô∏è *–°—Å—ã–ª–∫–∞:* [GitHub](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown

      # 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ—à–∏–±–æ–∫
      - name: Initialize repo
        id: init_repo
        run: |
          git config --global user.name "Edmond2007"
          git config --global user.email "edmondseropyan6@gmail.com"
          
          repo init \
            -u https://github.com/Miku-UI/manifesto \
            -b Vampire_v3 \
            --depth=${{ env.REPO_DEPTH }} \
            --partial-clone \
            --clone-filter=blob:limit=5M
          
          if [ $? -ne 0 ]; then
            echo "::error::Repo init failed"
            exit 1
          fi

      # 5. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞ —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –º–µ—Å—Ç–∞
      - name: Sync code
        id: sync_code
        run: |
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –ø–µ—Ä–µ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
          FREE_SPACE=$(df -h / | awk 'NR==2 {print $4}')
          echo "Free space before sync: $FREE_SPACE"
          
          repo sync \
            -c \
            -j$(nproc - 2) \  # –£–º–µ–Ω—å—à–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤
            --force-sync \
            --no-clone-bundle \
            --no-tags \
            --optimized-fetch \
            --current-branch
          
          SYNC_STATUS=$?
          
          # –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
          repo forall -c 'git gc --aggressive'
          
          if [ $SYNC_STATUS -ne 0 ]; then
            echo "::error::Repo sync failed"
            exit 1
          fi

          df -h

      # 6. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ device tree
      - name: Apply device trees
        id: apply_trees
        run: |
          git clone \
            --depth=1 \
            --filter=blob:limit=5M \
            https://github.com/Edmond2007/android_device_xiaomi_blossom_local_manifests.git \
            .repo/local_manifests
          
          if [ $? -ne 0 ]; then
            echo "::error::Failed to clone device trees"
            exit 1
          fi
          
          repo sync -c -j2 --fail-fast
          if [ $? -ne 0 ]; then
            echo "::error::Final sync failed"
            exit 1
          fi

      # 7. –°–±–æ—Ä–∫–∞ —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –ø–∞–º—è—Ç–∏
      - name: Build ROM
        id: build_rom
        run: |
          # –õ–∏–º–∏—Ç—ã –¥–ª—è —Å–±–æ—Ä–∫–∏
          export CCACHE_COMPRESS=1
          ccache -M 30G  # –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π –∫–µ—à
          ccache -s
          
          source build/envsetup.sh || exit 1
          lunch miku_blossom-userdebug || exit 1
          
          # –°–±–æ—Ä–∫–∞ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –º–µ—Å—Ç–∞
          while true; do
            free -h
            df -h /
            mka bacon -j$(($(nproc --all) - 2)) && break
            
            # –ï—Å–ª–∏ —Å–±–æ—Ä–∫–∞ —É–ø–∞–ª–∞ –∏–∑-–∑–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –º–µ—Å—Ç–∞
            if [ $(df / --output=pcent | tail -1 | tr -dc '0-9') -gt 90 ]; then
              echo "::warning::Low disk space, cleaning..."
              repo forall -c 'git gc --aggressive'
              ccache -c
              rm -rf out/target/product/*/obj/EXECUTABLES
            else
              exit 1
            fi
          done

      # 8. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      - name: Telegram notification (success)
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚úÖ *–°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞!*
            ‚ñ´Ô∏è *–í–µ—Ä—Å–∏—è:* Vampire_v3
            ‚ñ´Ô∏è *–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:* blossom
            ‚ñ´Ô∏è *–í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏:* ${{ steps.duration.outputs.time }}
            ‚ñ´Ô∏è *–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:* [Download](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown

      # 9. –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Miku-UI-Vampire_v3-${{ github.run_number }}
          path: out/target/product/blossom/*.zip
          retention-days: 3

      # 10. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ—É–¥–∞—á–µ
      - name: Telegram notification (failure)
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚ùå *–°–±–æ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞!*
            ‚ñ´Ô∏è *–≠—Ç–∞–ø:* ${{ steps.check_failure.outputs.failed_step }}
            ‚ñ´Ô∏è *–õ–æ–≥:* [View](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ‚ñ´Ô∏è *–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:* ${{ steps.duration.outputs.time }}
          parse_mode: markdown

      # 11. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –ø–∞–¥–µ–Ω–∏—è
      - name: Check failure reason
        if: failure()
        id: check_failure
        run: |
          if [[ "${{ steps.init_repo.outcome }}" == 'failure' ]]; then
            echo "failed_step=–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.sync_code.outcome }}" == 'failure' ]]; then
            echo "failed_step=–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.apply_trees.outcome }}" == 'failure' ]]; then
            echo "failed_step=–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ device tree" >> $GITHUB_OUTPUT
          else
            echo "failed_step=–°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏" >> $GITHUB_OUTPUT
          fi

      # 12. –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏
      - name: Calculate duration
        id: duration
        run: |
          START=${{ job.steps[*].startTime }}
          END=$(date -u +%s)
          DURATION=$((END - START))
          HOURS=$((DURATION / 3600))
          MINUTES=$(( (DURATION % 3600) / 60 ))
          echo "time=${HOURS}—á ${MINUTES}–º" >> $GITHUB_OUTPUT

      # 13. –û—á–∏—Å—Ç–∫–∞
      - name: Cleanup
        if: always()
        run: |
          sudo swapoff /swapfile || true
          sudo rm -f /swapfile || true
          ccache -s
